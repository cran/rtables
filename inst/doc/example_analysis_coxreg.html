<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Emily de la Rua and Gabriel Becker" />

<meta name="date" content="2025-04-10" />

<title>Example Complex Analysis Function: Modelling Cox Regression</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Example Complex Analysis Function:
Modelling Cox Regression</h1>
<h4 class="author">Emily de la Rua and Gabriel Becker</h4>
<h4 class="date">2025-04-10</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>In this vignette we will demonstrate how a complex analysis function
can be constructed in order to build highly-customized tables with
<code>rtables</code>. This example will detail the steps in creating an
analysis function to calculate a basic univariable Cox regression
summary table to analyze the treatment effect of the <code>ARM</code>
variable and any covariate/interaction effects for a survival analysis.
For a Cox regression analysis function with more customization options
and the capability of fitting multivariable Cox regression models, see
the <a href="https://insightsengineering.github.io/tern/main/reference/cox_regression.html"><code>summarize_coxreg()</code></a>
function from the <a href="https://insightsengineering.github.io/tern/main/index.html"><code>tern</code></a>
package, which builds upon the concepts used in the construction of this
example.</p>
<p>The packages used in this vignette are:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(rtables)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div>
</div>
<div id="data-pre-processing" class="section level2">
<h2>Data Pre-Processing</h2>
<p>First, we prepare the data that will be used to generate a table in
this example. We will use the example <code>ADTTE</code> (Time-To-Event
Analysis) dataset <code>ex_adtte</code> from the <code>formatters</code>
package, which contains our treatment variable <code>ARM</code>, several
variables that can be chosen as covariates, and censor variable
<code>CNSR</code> from which we will derive the event variable
<code>EVENT</code> required for our model. For the purpose of this
example, we will use age (<code>AGE</code>) and race (<code>RACE</code>)
as our covariates.</p>
<p>We prepare the data as needed to observe the desired effects in our
summary table. <code>PARAMCD</code> is filtered so that only records of
overall survival (OS) are included, and we filter and mutate to include
only the levels of interest in our covariates. The <code>ARM</code>
variable is mutated to indicate that <code>&quot;B: Placebo&quot;</code> should be
used as the reference level of our treatment variable, and the
<code>EVENT</code> variable is derived from <code>CNSR</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>adtte <span class="ot">&lt;-</span> ex_adtte</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>anl <span class="ot">&lt;-</span> adtte <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(PARAMCD <span class="sc">==</span> <span class="st">&quot;OS&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(ARM <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;A: Drug X&quot;</span>, <span class="st">&quot;B: Placebo&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(RACE <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;ASIAN&quot;</span>, <span class="st">&quot;BLACK OR AFRICAN AMERICAN&quot;</span>, <span class="st">&quot;WHITE&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RACE =</span> <span class="fu">droplevels</span>(RACE)) <span class="sc">%&gt;%</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ARM =</span> <span class="fu">droplevels</span>(stats<span class="sc">::</span><span class="fu">relevel</span>(ARM, <span class="st">&quot;B: Placebo&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">EVENT =</span> <span class="dv">1</span> <span class="sc">-</span> CNSR)</span></code></pre></div>
</div>
<div id="creating-helper-functions-cox-regression-model-calculations" class="section level2">
<h2>Creating Helper Functions: Cox Regression Model Calculations</h2>
<div id="tidy-method-for-summary.coxph-objects-tidy.summary.coxph" class="section level3">
<h3><code>tidy</code> Method for <code>summary.coxph</code> Objects:
<code>tidy.summary.coxph</code></h3>
<p>This method allows the <code>tidy</code> function from the
<code>broom</code> package to operate on <code>summary.coxph</code>
output, extracting the values of interest to this analysis and returning
a tidied <code>tibble::tibble()</code> object.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>tidy.summary.coxph <span class="ot">&lt;-</span> <span class="cf">function</span>(x, ...) {</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="fu">is</span>(x, <span class="st">&quot;summary.coxph&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> x<span class="sc">$</span>coefficients</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  confint <span class="ot">&lt;-</span> x<span class="sc">$</span>conf.int</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  levels <span class="ot">&lt;-</span> <span class="fu">rownames</span>(pval)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  pval <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>(pval)</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  confint <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">as_tibble</span>(confint)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  ret <span class="ot">&lt;-</span> <span class="fu">cbind</span>(pval[, <span class="fu">grepl</span>(<span class="st">&quot;Pr&quot;</span>, <span class="fu">names</span>(pval))], confint)</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  ret<span class="sc">$</span>level <span class="ot">&lt;-</span> levels</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  ret<span class="sc">$</span>n <span class="ot">&lt;-</span> x[[<span class="st">&quot;n&quot;</span>]]</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  ret</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="function-to-estimate-interaction-effects-h_coxreg_inter_effect" class="section level3">
<h3>Function to Estimate Interaction Effects:
<code>h_coxreg_inter_effect</code></h3>
<p>The <code>h_coxreg_inter_effect</code> helper function is used within
the following helper function,
<code>h_coxreg_extract_interaction</code>, to estimate interaction
effects from a given model for a given covariate. The function
calculates the desired statistics from the given model and returns a
<code>data.frame</code> with label information for each row as well as
the statistics <code>n</code>, <code>hr</code> (hazard ratio),
<code>lcl</code> (CI lower bound), <code>ucl</code> (CI upper bound),
<code>pval</code> (effect p-value), and <code>pval_inter</code>
(interaction p-value). If a numeric covariate is selected, the median
value is used as the sole “level” for which an interaction effect is
calculated. For non-numeric covariates, an interaction effect is
calculated for each level of the covariate, with each result returned on
a separate row.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>h_coxreg_inter_effect <span class="ot">&lt;-</span> <span class="cf">function</span>(x,</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>                                  effect,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>                                  covar,</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>                                  mod,</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>                                  label,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>                                  control,</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>                                  data) {</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) {</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>    betas <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">coef</span>(mod)</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    attrs <span class="ot">&lt;-</span> <span class="fu">attr</span>(stats<span class="sc">::</span><span class="fu">terms</span>(mod), <span class="st">&quot;term.labels&quot;</span>)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    term_indices <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="at">pattern =</span> effect, <span class="at">x =</span> attrs[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&quot;strata</span><span class="sc">\\</span><span class="st">(&quot;</span>, attrs)])</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>    betas <span class="ot">&lt;-</span> betas[term_indices]</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    betas_var <span class="ot">&lt;-</span> <span class="fu">diag</span>(stats<span class="sc">::</span><span class="fu">vcov</span>(mod))[term_indices]</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    betas_cov <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">vcov</span>(mod)[term_indices[<span class="dv">1</span>], term_indices[<span class="dv">2</span>]]</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    xval <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">median</span>(x)</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    effect_index <span class="ot">&lt;-</span> <span class="sc">!</span><span class="fu">grepl</span>(covar, <span class="fu">names</span>(betas))</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>    coef_hat <span class="ot">&lt;-</span> betas[effect_index] <span class="sc">+</span> xval <span class="sc">*</span> betas[<span class="sc">!</span>effect_index]</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>    coef_se <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(betas_var[effect_index] <span class="sc">+</span> xval<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> betas_var[<span class="sc">!</span>effect_index] <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> xval <span class="sc">*</span> betas_cov)</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>    q_norm <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">qnorm</span>((<span class="dv">1</span> <span class="sc">+</span> control<span class="sc">$</span>conf_level) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>    var_lvl <span class="ot">&lt;-</span> <span class="fu">paste0</span>(effect, <span class="fu">levels</span>(data[[effect]])[<span class="sc">-</span><span class="dv">1</span>]) <span class="co"># [-1]: reference level</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>    giv_lvl <span class="ot">&lt;-</span> <span class="fu">paste0</span>(covar, <span class="fu">levels</span>(data[[covar]]))</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>    design_mat <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">effect =</span> var_lvl, <span class="at">covar =</span> giv_lvl)</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>    design_mat <span class="ot">&lt;-</span> design_mat[<span class="fu">order</span>(design_mat<span class="sc">$</span>effect, design_mat<span class="sc">$</span>covar), ]</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>    design_mat <span class="ot">&lt;-</span> <span class="fu">within</span>(<span class="at">data =</span> design_mat, <span class="at">expr =</span> {</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>      inter <span class="ot">&lt;-</span> <span class="fu">paste0</span>(effect, <span class="st">&quot;:&quot;</span>, covar)</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>      rev_inter <span class="ot">&lt;-</span> <span class="fu">paste0</span>(covar, <span class="st">&quot;:&quot;</span>, effect)</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>    })</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>    split_by_variable <span class="ot">&lt;-</span> design_mat<span class="sc">$</span>effect</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>    interaction_names <span class="ot">&lt;-</span> <span class="fu">paste</span>(design_mat<span class="sc">$</span>effect, design_mat<span class="sc">$</span>covar, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>    mmat <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">model.matrix</span>(mod)[<span class="dv">1</span>, ]</span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>    mmat[<span class="sc">!</span>mmat <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>    design_mat <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="at">X =</span> design_mat, <span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x) {</span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>      mmat[<span class="fu">names</span>(mmat) <span class="sc">%in%</span> x[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">names</span>(x) <span class="sc">==</span> <span class="st">&quot;covar&quot;</span>)]] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>      mmat</span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>    })</span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>    <span class="fu">colnames</span>(design_mat) <span class="ot">&lt;-</span> interaction_names</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>    coef <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">coef</span>(mod)</span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>    vcov <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">vcov</span>(mod)</span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>    betas <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(coef)</span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>    coef_hat <span class="ot">&lt;-</span> <span class="fu">t</span>(design_mat) <span class="sc">%*%</span> betas</span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>    <span class="fu">dimnames</span>(coef_hat)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">&quot;coef&quot;</span></span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>    coef_se <span class="ot">&lt;-</span> <span class="fu">apply</span>(design_mat, <span class="dv">2</span>, <span class="cf">function</span>(x) {</span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a>      vcov_el <span class="ot">&lt;-</span> <span class="fu">as.logical</span>(x)</span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>      y <span class="ot">&lt;-</span> vcov[vcov_el, vcov_el]</span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a>      y <span class="ot">&lt;-</span> <span class="fu">sum</span>(y)</span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>      y <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(y)</span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a>      y</span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a>    })</span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a>    q_norm <span class="ot">&lt;-</span> stats<span class="sc">::</span><span class="fu">qnorm</span>((<span class="dv">1</span> <span class="sc">+</span> control<span class="sc">$</span>conf_level) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">cbind</span>(coef_hat, <span class="st">`</span><span class="at">se(coef)</span><span class="st">`</span> <span class="ot">=</span> coef_se)</span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">apply</span>(y, <span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a>      x[<span class="st">&quot;hr&quot;</span>] <span class="ot">&lt;-</span> <span class="fu">exp</span>(x[<span class="st">&quot;coef&quot;</span>])</span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a>      x[<span class="st">&quot;lcl&quot;</span>] <span class="ot">&lt;-</span> <span class="fu">exp</span>(x[<span class="st">&quot;coef&quot;</span>] <span class="sc">-</span> q_norm <span class="sc">*</span> x[<span class="st">&quot;se(coef)&quot;</span>])</span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>      x[<span class="st">&quot;ucl&quot;</span>] <span class="ot">&lt;-</span> <span class="fu">exp</span>(x[<span class="st">&quot;coef&quot;</span>] <span class="sc">+</span> q_norm <span class="sc">*</span> x[<span class="st">&quot;se(coef)&quot;</span>])</span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a>      x</span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a>    })</span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">t</span>(y)</span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">by</span>(y, split_by_variable, identity)</span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">lapply</span>(y, as.matrix)</span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a>    <span class="fu">attr</span>(y, <span class="st">&quot;details&quot;</span>) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a>      <span class="st">&quot;Estimations of &quot;</span>, effect, <span class="st">&quot; hazard ratio given the level of &quot;</span>, covar, <span class="st">&quot; compared to &quot;</span>,</span>
<span id="cb4-63"><a href="#cb4-63" tabindex="-1"></a>      effect, <span class="st">&quot; level &quot;</span>, <span class="fu">levels</span>(data[[effect]])[<span class="dv">1</span>], <span class="st">&quot;.&quot;</span></span>
<span id="cb4-64"><a href="#cb4-64" tabindex="-1"></a>    )</span>
<span id="cb4-65"><a href="#cb4-65" tabindex="-1"></a>    xval <span class="ot">&lt;-</span> <span class="fu">levels</span>(data[[covar]])</span>
<span id="cb4-66"><a href="#cb4-66" tabindex="-1"></a>  }</span>
<span id="cb4-67"><a href="#cb4-67" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb4-68"><a href="#cb4-68" tabindex="-1"></a>    <span class="at">effect =</span> <span class="st">&quot;Covariate:&quot;</span>,</span>
<span id="cb4-69"><a href="#cb4-69" tabindex="-1"></a>    <span class="at">term =</span> <span class="fu">rep</span>(covar, <span class="fu">length</span>(xval)),</span>
<span id="cb4-70"><a href="#cb4-70" tabindex="-1"></a>    <span class="at">term_label =</span> <span class="fu">as.character</span>(<span class="fu">paste0</span>(<span class="st">&quot;  &quot;</span>, xval)),</span>
<span id="cb4-71"><a href="#cb4-71" tabindex="-1"></a>    <span class="at">level =</span> <span class="fu">as.character</span>(xval),</span>
<span id="cb4-72"><a href="#cb4-72" tabindex="-1"></a>    <span class="at">n =</span> <span class="cn">NA</span>,</span>
<span id="cb4-73"><a href="#cb4-73" tabindex="-1"></a>    <span class="at">hr =</span> <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">exp</span>(coef_hat) <span class="cf">else</span> y[[<span class="dv">1</span>]][, <span class="st">&quot;hr&quot;</span>],</span>
<span id="cb4-74"><a href="#cb4-74" tabindex="-1"></a>    <span class="at">lcl =</span> <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">exp</span>(coef_hat <span class="sc">-</span> q_norm <span class="sc">*</span> coef_se) <span class="cf">else</span> y[[<span class="dv">1</span>]][, <span class="st">&quot;lcl&quot;</span>],</span>
<span id="cb4-75"><a href="#cb4-75" tabindex="-1"></a>    <span class="at">ucl =</span> <span class="cf">if</span> (<span class="fu">is.numeric</span>(x)) <span class="fu">exp</span>(coef_hat <span class="sc">+</span> q_norm <span class="sc">*</span> coef_se) <span class="cf">else</span> y[[<span class="dv">1</span>]][, <span class="st">&quot;ucl&quot;</span>],</span>
<span id="cb4-76"><a href="#cb4-76" tabindex="-1"></a>    <span class="at">pval =</span> <span class="cn">NA</span>,</span>
<span id="cb4-77"><a href="#cb4-77" tabindex="-1"></a>    <span class="at">pval_inter =</span> <span class="cn">NA</span>,</span>
<span id="cb4-78"><a href="#cb4-78" tabindex="-1"></a>    <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb4-79"><a href="#cb4-79" tabindex="-1"></a>  )</span>
<span id="cb4-80"><a href="#cb4-80" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="function-to-extract-effect-information-h_coxreg_extract_interaction" class="section level3">
<h3>Function to Extract Effect Information:
<code>h_coxreg_extract_interaction</code></h3>
<p>Using the previous two helper functions,
<code>h_coxreg_extract_interaction</code> uses ANOVA to extract
information from the given model about the given covariate. This
function will extract different information depending on whether the
effect of interest is a treatment/main effect or an interaction effect,
and returns a <code>data.frame</code> with label information for each
row (corresponding to each effect) as well as the statistics
<code>n</code>, <code>hr</code>, <code>lcl</code>, <code>ucl</code>,
<code>pval</code>, and <code>pval_inter</code> (for interaction effects
only). This helper function is used directly within our analysis
function to analyze the Cox regression model and extract relevant
information to be processed and displayed within our output table.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>h_coxreg_extract_interaction <span class="ot">&lt;-</span> <span class="cf">function</span>(effect, covar, mod, data) {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  control <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">pval_method =</span> <span class="st">&quot;wald&quot;</span>, <span class="at">ties =</span> <span class="st">&quot;exact&quot;</span>, <span class="at">conf_level =</span> <span class="fl">0.95</span>, <span class="at">interaction =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  test_statistic <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">wald =</span> <span class="st">&quot;Wald&quot;</span>, <span class="at">likelihood =</span> <span class="st">&quot;LR&quot;</span>)[control<span class="sc">$</span>pval_method]</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  mod_aov <span class="ot">&lt;-</span> <span class="fu">withCallingHandlers</span>(</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    <span class="at">expr =</span> car<span class="sc">::</span><span class="fu">Anova</span>(mod, <span class="at">test.statistic =</span> test_statistic, <span class="at">type =</span> <span class="st">&quot;III&quot;</span>),</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    <span class="at">message =</span> <span class="cf">function</span>(m) <span class="fu">invokeRestart</span>(<span class="st">&quot;muffleMessage&quot;</span>)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  )</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>  msum <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">attr</span>(stats<span class="sc">::</span><span class="fu">terms</span>(mod), <span class="st">&quot;order&quot;</span>) <span class="sc">==</span> <span class="dv">2</span>)) <span class="fu">summary</span>(mod, <span class="at">conf.int =</span> control<span class="sc">$</span>conf_level) <span class="cf">else</span> mod_aov</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  sum_anova <span class="ot">&lt;-</span> broom<span class="sc">::</span><span class="fu">tidy</span>(msum)</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(<span class="fu">attr</span>(stats<span class="sc">::</span><span class="fu">terms</span>(mod), <span class="st">&quot;order&quot;</span>) <span class="sc">==</span> <span class="dv">2</span>)) {</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>    effect_aov <span class="ot">&lt;-</span> mod_aov[effect, , drop <span class="ot">=</span> <span class="cn">TRUE</span>]</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    pval <span class="ot">&lt;-</span> effect_aov[[<span class="fu">grep</span>(<span class="at">pattern =</span> <span class="st">&quot;Pr&quot;</span>, <span class="at">x =</span> <span class="fu">names</span>(effect_aov)), drop <span class="ot">=</span> <span class="cn">TRUE</span>]]</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>    sum_main <span class="ot">&lt;-</span> sum_anova[<span class="fu">grepl</span>(effect, sum_anova<span class="sc">$</span>level), ]</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>    term_label <span class="ot">&lt;-</span> <span class="cf">if</span> (effect <span class="sc">==</span> covar) {</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="fu">levels</span>(data[[covar]])[<span class="dv">2</span>], <span class="st">&quot; vs control (&quot;</span>, <span class="fu">levels</span>(data[[covar]])[<span class="dv">1</span>], <span class="st">&quot;)&quot;</span>)</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>      <span class="fu">unname</span>(formatters<span class="sc">::</span><span class="fu">var_labels</span>(data, <span class="at">fill =</span> <span class="cn">TRUE</span>)[[covar]])</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>    }</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>      <span class="at">effect =</span> <span class="fu">ifelse</span>(covar <span class="sc">==</span> effect, <span class="st">&quot;Treatment:&quot;</span>, <span class="st">&quot;Covariate:&quot;</span>),</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>      <span class="at">term =</span> covar, <span class="at">term_label =</span> term_label,</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>      <span class="at">level =</span> <span class="fu">levels</span>(data[[effect]])[<span class="dv">2</span>],</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>      <span class="at">n =</span> mod[[<span class="st">&quot;n&quot;</span>]], <span class="at">hr =</span> <span class="fu">unname</span>(sum_main[<span class="st">&quot;exp(coef)&quot;</span>]), <span class="at">lcl =</span> <span class="fu">unname</span>(sum_main[<span class="fu">grep</span>(<span class="st">&quot;lower&quot;</span>, <span class="fu">names</span>(sum_main))]),</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>      <span class="at">ucl =</span> <span class="fu">unname</span>(sum_main[<span class="fu">grep</span>(<span class="st">&quot;upper&quot;</span>, <span class="fu">names</span>(sum_main))]), <span class="at">pval =</span> pval,</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>      <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>    )</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>    y<span class="sc">$</span>pval_inter <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>    y</span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>    pval <span class="ot">&lt;-</span> sum_anova[sum_anova<span class="sc">$</span>term <span class="sc">==</span> effect, ][[<span class="st">&quot;p.value&quot;</span>]]</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>    <span class="do">## Test the interaction effect</span></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>    pval_inter <span class="ot">&lt;-</span> sum_anova[<span class="fu">grep</span>(<span class="st">&quot;:&quot;</span>, sum_anova<span class="sc">$</span>term), ][[<span class="st">&quot;p.value&quot;</span>]]</span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>    covar_test <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>      <span class="at">effect =</span> <span class="st">&quot;Covariate:&quot;</span>,</span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>      <span class="at">term =</span> covar, <span class="at">term_label =</span> <span class="fu">unname</span>(formatters<span class="sc">::</span><span class="fu">var_labels</span>(data, <span class="at">fill =</span> <span class="cn">TRUE</span>)[[covar]]),</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>      <span class="at">level =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>      <span class="at">n =</span> mod<span class="sc">$</span>n, <span class="at">hr =</span> <span class="cn">NA</span>, <span class="at">lcl =</span> <span class="cn">NA</span>, <span class="at">ucl =</span> <span class="cn">NA</span>, <span class="at">pval =</span> pval,</span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>      <span class="at">pval_inter =</span> pval_inter,</span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a>      <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>    )</span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>    <span class="do">## Estimate the interaction</span></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">h_coxreg_inter_effect</span>(</span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a>      data[[covar]],</span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>      <span class="at">covar =</span> covar,</span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>      <span class="at">effect =</span> effect,</span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>      <span class="at">mod =</span> mod,</span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>      <span class="at">label =</span> <span class="fu">unname</span>(formatters<span class="sc">::</span><span class="fu">var_labels</span>(data, <span class="at">fill =</span> <span class="cn">TRUE</span>)[[covar]]),</span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a>      <span class="at">control =</span> control,</span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a>      <span class="at">data =</span> data</span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a>    )</span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a>    <span class="fu">rbind</span>(covar_test, y)</span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a>  }</span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="creating-a-helper-function-cached_model" class="section level2">
<h2>Creating a Helper Function: <code>cached_model</code></h2>
<p>Next, we will create a helper function, <code>cached_model</code>,
which will be used within our analysis function to cache and return the
fitted Cox regression model for the current covariate. The
<code>df</code> argument will be directly inherited from the
<code>df</code> argument passed to the analysis function, which contains
the full dataset being analyzed. The <code>cov</code> argument will be
the covariate that is being analyzed depending on the current row
context. If the treatment effect is currently being analyzed, this value
will be an empty string. The <code>cache_env</code> parameter will be an
environment object which is used to store the model for the current
covariate, also passed down from the analysis function. Of course, this
function can also be run outside of the analysis function and will still
cache and return a Cox regression model.</p>
<p>Using these arguments, the <code>cached_model</code> function first
checks if a model for the given covariate <code>cov</code> is already
stored in the caching environment <code>cache_env</code>. If so, then
this model is retrieved and returned by <code>cached_model</code>. If
not, the model must be constructed. This is done by first constructing
the model formula, <code>model_form</code>, starting with only the
treatment effect (<code>ARM</code>) and adding a covariate effect if one
is currently being analyzed. Then a Cox regression model is fit using
<code>df</code> and the model formula, and this model is both returned
and stored in the caching environment object as
<code>cache_env[[cov]]</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>cached_model <span class="ot">&lt;-</span> <span class="cf">function</span>(df, cov, cache_env) {</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="do">## Check if a model already exists for</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="do">## `cov` in the caching environment</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(cache_env[[cov]])) {</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="do">## If model already exists, retrieve it from cache_env</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    model <span class="ot">&lt;-</span> cache_env[[cov]]</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    <span class="do">## Build model formula</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>    model_form <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;survival::Surv(AVAL, EVENT) ~ ARM&quot;</span>)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(cov) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>      model_form <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="fu">c</span>(model_form, cov), <span class="at">collapse =</span> <span class="st">&quot; * &quot;</span>)</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>      cov <span class="ot">&lt;-</span> <span class="st">&quot;ARM&quot;</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    }</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    <span class="do">## Calculate Cox regression model</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    model <span class="ot">&lt;-</span> survival<span class="sc">::</span><span class="fu">coxph</span>(</span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>      <span class="at">formula =</span> stats<span class="sc">::</span><span class="fu">as.formula</span>(model_form),</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>      <span class="at">data =</span> df,</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>      <span class="at">ties =</span> <span class="st">&quot;exact&quot;</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>    )</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    <span class="do">## Store model in the caching environment</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>    cache_env[[cov]] <span class="ot">&lt;-</span> model</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>  }</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>  model</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="creating-the-analysis-function-a_cox_summary" class="section level2">
<h2>Creating the Analysis Function: <code>a_cox_summary</code></h2>
<p>With our data prepared and helper function created, we can proceed to
construct our analysis function <code>a_cox_summary</code>, which will
be used to populate all of the rows in our table. In order to be used to
generate both data rows (for interaction effects) and content rows (for
main effects), we must create a function that can be used as both
<code>afun</code> in <code>analyze</code> and <code>cfun</code> in
<code>summarize_row_groups</code>. Therefore, our function must accept
the <code>labelstr</code> parameter.</p>
<p>The arguments of our analysis function will be as follows:</p>
<ul>
<li><code>df</code> - a <code>data.frame</code> of the full dataset
required to fit the Cox regression model.</li>
<li><code>labelstr</code> - the <code>string</code> label for the
variable being analyzed in the current row/column split context.</li>
<li><code>.spl_context</code> - a <code>data.frame</code> containing the
<code>value</code> column which is used by this analysis function to
determine the name of the variable/covariate in the current split. For
more details on the information stored by <code>.spl_context</code> see
<code>?analyze</code>.</li>
<li><code>stat</code> and <code>format</code> - <code>string</code>s
that indicate which statistic column we are currently in and what format
should be applied to print the statistic.</li>
<li><code>cache_env</code> - an <code>environment</code> object that can
be used to store cached models so that we can prevent repeatedly fitting
the same model. Instead, each model will be generated once per covariate
and then reused. This argument will be passed directly to the
<code>cached_model</code> helper function we defined previously.</li>
<li><code>cov_main</code> - a <code>logical</code> value indicating
whether or not the current row is summarizing covariate main
effects.</li>
</ul>
<p>The analysis function works within a given row/column split context
by using the current covariate (<code>cov</code>) and the
<code>cached_model</code> function to obtain the desired Cox regression
model. From this model, the <code>h_coxreg_extract_interaction</code>
function is able to extract information/statistics relevant to the
analysis and store it in a <code>data.frame</code>. The rows in this
<code>data.frame</code> that are of interest in the current row/column
split context are then extracted and the statistic to be printed in the
current column is retrieved from these rows. Finally, the formatted
cells with this statistic are returned as a
<code>VerticalRowsSection</code> object. For more detail see the
commented function code below, where the purpose of each line within
<code>a_cox_summary</code> is described.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>a_cox_summary <span class="ot">&lt;-</span> <span class="cf">function</span>(df,</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>                          <span class="at">labelstr =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>                          .spl_context,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>                          stat,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>                          format,</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>                          cache_env,</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>                          <span class="at">cov_main =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  <span class="do">## Get current covariate (variable used in latest row split)</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  cov <span class="ot">&lt;-</span> <span class="fu">tail</span>(.spl_context<span class="sc">$</span>value, <span class="dv">1</span>)</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  <span class="do">## If currently analyzing treatment effect (ARM) replace empty</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  <span class="do">## value of cov with &quot;ARM&quot; so the correct model row is analyzed</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(cov) <span class="sc">==</span> <span class="dv">0</span>) cov <span class="ot">&lt;-</span> <span class="st">&quot;ARM&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  <span class="do">## Use cached_model to get the fitted Cox regression</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  <span class="do">## model for the current covariate</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">cached_model</span>(<span class="at">df =</span> df, <span class="at">cov =</span> cov, <span class="at">cache_env =</span> cache_env)</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>  <span class="do">## Extract levels of cov to be used as row labels for interaction effects.</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>  <span class="do">## If cov is numeric, the median value of cov is used as a row label instead</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>  cov_lvls <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.factor</span>(df[[cov]])) <span class="fu">levels</span>(df[[cov]]) <span class="cf">else</span> <span class="fu">as.character</span>(<span class="fu">median</span>(df[[cov]]))</span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>  <span class="do">## Use function to calculate and extract information relevant to cov from the model</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>  cov_rows <span class="ot">&lt;-</span> <span class="fu">h_coxreg_extract_interaction</span>(<span class="at">effect =</span> <span class="st">&quot;ARM&quot;</span>, <span class="at">covar =</span> cov, <span class="at">mod =</span> model, <span class="at">data =</span> df)</span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>  <span class="do">## Effect p-value is only printed for treatment effect row</span></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>cov <span class="sc">==</span> <span class="st">&quot;ARM&quot;</span>) cov_rows[, <span class="st">&quot;pval&quot;</span>] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>  <span class="do">## Extract rows containing statistics for cov from model information</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>cov_main) {</span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>    <span class="do">## Extract rows for main effect</span></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>    cov_rows <span class="ot">&lt;-</span> cov_rows[cov_rows<span class="sc">$</span>level <span class="sc">%in%</span> cov_lvls, ]</span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>    <span class="do">## Extract all non-main effect rows</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>    cov_rows <span class="ot">&lt;-</span> cov_rows[<span class="fu">nchar</span>(cov_rows<span class="sc">$</span>level) <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>  }</span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>  <span class="do">## Extract value(s) of statistic for current column and variable/levels</span></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>  stat_vals <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">apply</span>(cov_rows[stat], <span class="dv">1</span>, <span class="cf">function</span>(x) x, <span class="at">simplify =</span> <span class="cn">FALSE</span>))</span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>  <span class="do">## Assign labels: covariate name for main effect (content) rows, ARM comparison description</span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>  <span class="do">## for treatment effect (content) row, cov_lvls for interaction effect (data) rows</span></span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a>  nms <span class="ot">&lt;-</span> <span class="cf">if</span> (cov_main) labelstr <span class="cf">else</span> <span class="cf">if</span> (cov <span class="sc">==</span> <span class="st">&quot;ARM&quot;</span>) cov_rows<span class="sc">$</span>term_label <span class="cf">else</span> cov_lvls</span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a>  <span class="do">## Return formatted/labelled row</span></span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a>  <span class="fu">in_rows</span>(</span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a>    <span class="at">.list =</span> stat_vals,</span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a>    <span class="at">.names =</span> nms,</span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a>    <span class="at">.labels =</span> nms,</span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a>    <span class="at">.formats =</span> <span class="fu">setNames</span>(<span class="fu">rep</span>(format, <span class="fu">length</span>(nms)), nms),</span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a>    <span class="at">.format_na_strs =</span> <span class="fu">setNames</span>(<span class="fu">rep</span>(<span class="st">&quot;&quot;</span>, <span class="fu">length</span>(nms)), nms)</span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a>  )</span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="selecting-parameters" class="section level2">
<h2>Selecting Parameters</h2>
<p>We are able to customize our Cox regression summary using this
analysis function by selecting covariates (and their labels), statistics
(and their labels), and statistic formats to use when generating the
output table. We also initialize a new environment object to be used by
the analysis function as the caching environment to store our models in.
For the purpose of this example, we will choose all 5 of the possible
statistics to include in the table: n, hazard ratio, confidence
interval, effect p-value, and interaction p-value.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>my_covs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;AGE&quot;</span>, <span class="st">&quot;RACE&quot;</span>) <span class="do">## Covariates</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>my_cov_labs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Age&quot;</span>, <span class="st">&quot;Race&quot;</span>) <span class="do">## Covariate labels</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>my_stats <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;hr&quot;</span>, <span class="fu">c</span>(<span class="st">&quot;lcl&quot;</span>, <span class="st">&quot;ucl&quot;</span>), <span class="st">&quot;pval&quot;</span>, <span class="st">&quot;pval_inter&quot;</span>) <span class="do">## Statistics</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>my_stat_labs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;n&quot;</span>, <span class="st">&quot;Hazard Ratio&quot;</span>, <span class="st">&quot;95% CI&quot;</span>, <span class="st">&quot;p-value</span><span class="sc">\n</span><span class="st">(effect)&quot;</span>, <span class="st">&quot;p-value</span><span class="sc">\n</span><span class="st">(interaction)&quot;</span>) <span class="do">## Statistic labels</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>my_formats <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="at">n =</span> <span class="st">&quot;xx&quot;</span>, <span class="at">hr =</span> <span class="st">&quot;xx.xx&quot;</span>, <span class="at">lcl =</span> <span class="st">&quot;(xx.xx, xx.xx)&quot;</span>, <span class="at">pval =</span> <span class="st">&quot;xx.xxxx&quot;</span>, <span class="at">pval_inter =</span> <span class="st">&quot;xx.xxxx&quot;</span> <span class="do">## Statistic formats</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>my_env <span class="ot">&lt;-</span> <span class="fu">new.env</span>()</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>ny_cache_env <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="fu">length</span>(my_stats), <span class="fu">list</span>(my_env)) <span class="do">## Caching environment</span></span></code></pre></div>
</div>
<div id="constructing-the-table" class="section level2">
<h2>Constructing the Table</h2>
<p>Finally, the table layout can be constructed and used to build the
desired table.</p>
<p>We first split our <code>basic_table</code> using
<code>split_cols_by_multivar</code> to ensure that each statistic exists
in its own column. To do so, we choose a variable (in this case
<code>STUDYID</code>) which shares the same value in every row, and use
it as the split variable for every column so that the full dataset is
used to compute the model for every column. We use the
<code>extra_args</code> argument for which each list element’s element
positions correspond to the children of (columns generated by) this
split. These arguments are inherited by all following layout elements
operating within this split, which use these elements as argument
inputs. To elaborate on this, we have three elements in
<code>extra_args</code>: <code>stat</code>, <code>format</code>, and
<code>cache_env</code> - each of which are arguments of
<code>a_cox_summary</code> and have length equal to the number of
columns (as defined above). For each use of our analysis function
following this column split, depending on the current column context,
the corresponding element of each of these three list elements will be
inherited from <code>extra_args</code> and used as input. For example,
if <code>analyze_colvars</code> is called with
<code>a_cox_summary</code> as <code>afun</code> and is performing
calculations for column 1, <code>my_stats[1]</code> (<code>&quot;n&quot;</code>)
will be given as argument <code>stat</code>, <code>my_formats[1]</code>
(<code>&quot;xx&quot;</code>) as argument <code>format</code>, and
<code>my_cache_env[1]</code> (<code>my_env</code>) as
<code>cache_env</code>. This is useful for our table since we want each
column to print out values for a different statistic and apply its
corresponding format.</p>
<p>Next, we can use <code>summarize_row_groups</code> to generate the
content row for treatment effect. This is the first instance where
<code>extra_args</code> from the column split will be inherited and used
as argument input in <code>cfun</code>.</p>
<p>After generating the treatment effect row, we want to add rows for
covariates. We use <code>split_rows_by_multivar</code> to split rows by
covariate and apply appropriate labels.</p>
<p>Following this row split, we use <code>summarize_row_groups</code>
with <code>a_cox_summary</code> as <code>cfun</code> to generate one
content row for each covariate main effect. Once again the contents of
<code>extra_args</code> from the column split are inherited as input.
Here we specify <code>cov_main = TRUE</code> in the
<code>extra_args</code> argument so that main effects rather than
interactions are considered. Since this is not a split, this instance of
<code>extra_args</code> is not inherited by any following layout
elements. As <code>cov_main</code> is a singular value,
<code>cov_main = TRUE</code> will be used within every column
context.</p>
<p>The last part of our table is the covariate interaction effects. We
use <code>analyze_colvars</code> with <code>a_cox_summary</code> as
<code>afun</code>, and again inherit <code>extra_args</code> from the
column split. Using an <code>rtables</code> “analyze” function generates
data rows, with one row corresponding to each covariate level (or median
value, for numeric covariates), nested under the content row (main
effect) for that same covariate.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>lyt <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="do">## Column split: one column for each statistic</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="fu">split_cols_by_multivar</span>(</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>    <span class="at">vars =</span> <span class="fu">rep</span>(<span class="st">&quot;STUDYID&quot;</span>, <span class="fu">length</span>(my_stats)),</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>    <span class="at">varlabels =</span> my_stat_labs,</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>    <span class="at">extra_args =</span> <span class="fu">list</span>(</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>      <span class="at">stat =</span> my_stats,</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>      <span class="at">format =</span> my_formats,</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>      <span class="at">cache_env =</span> ny_cache_env</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>    )</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>  <span class="do">## Create content row for treatment effect</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="fu">summarize_row_groups</span>(<span class="at">cfun =</span> a_cox_summary) <span class="sc">%&gt;%</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>  <span class="do">## Row split: one content row for each covariate</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>  <span class="fu">split_rows_by_multivar</span>(</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>    <span class="at">vars =</span> my_covs,</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>    <span class="at">varlabels =</span> my_cov_labs,</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>    <span class="at">split_label =</span> <span class="st">&quot;Covariate:&quot;</span>,</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    <span class="at">indent_mod =</span> <span class="sc">-</span><span class="dv">1</span> <span class="do">## Align split label left</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>  <span class="do">## Create content rows for covariate main effects</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>  <span class="fu">summarize_row_groups</span>(</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>    <span class="at">cfun =</span> a_cox_summary,</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>    <span class="at">extra_args =</span> <span class="fu">list</span>(<span class="at">cov_main =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>  <span class="do">## Create data rows for covariate interaction effects</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>  <span class="fu">analyze_colvars</span>(<span class="at">afun =</span> a_cox_summary)</span></code></pre></div>
<p>Using our pre-processed <code>anl</code> dataset, we can now build
and output our final Cox regression summary table.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>cox_tbl <span class="ot">&lt;-</span> <span class="fu">build_table</span>(lyt, anl)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>cox_tbl</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">#&gt;                                                                         p-value       p-value   </span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">#&gt;                                      n    Hazard Ratio      95% CI      (effect)   (interaction)</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">#&gt; ————————————————————————————————————————————————————————————————————————————————————————————————</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">#&gt; A: Drug X vs control (B: Placebo)   247       0.97       (0.71, 1.32)    0.8243                 </span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">#&gt; Covariate:                                                                                      </span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co">#&gt;   Age                               247                                               0.7832    </span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">#&gt;     34                                        0.92       (0.68, 1.26)                           </span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="co">#&gt;   Race                              247                                               0.7441    </span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="co">#&gt;     ASIAN                                     1.03       (0.68, 1.57)                           </span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="co">#&gt;     BLACK OR AFRICAN AMERICAN                 0.78       (0.41, 1.49)                           </span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co">#&gt;     WHITE                                     1.06       (0.55, 2.04)</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
