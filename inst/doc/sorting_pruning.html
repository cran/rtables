<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Gabriel Becker and Adrian Waddell" />

<meta name="date" content="2021-01-19" />

<title>Pruning and Sorting Tables</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Pruning and Sorting Tables</h1>
<h4 class="author">Gabriel Becker and Adrian Waddell</h4>
<h4 class="date">2021-01-19</h4>



<style type="text/css">
.reveal .r code {
    white-space: pre;
}
</style>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Often we want to filter or reorder subsections of a table in ways that take into account the table structure. For example</p>
<ul>
<li>sorting subtables corresponding to factor levels so that most commonly observed levels occur first in the table</li>
<li>Removing subtables which represent 0 observations or which after other filtering contain 0 rows</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(rtables)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(dplyr)</a></code></pre></div>
</div>
<div id="a-table-in-need-of-attention" class="section level2">
<h2>A Table In Need of Attention</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">rawtable &lt;-<span class="st"> </span><span class="kw">basic_table</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="st">    </span><span class="kw">split_cols_by</span>(<span class="st">&quot;ARM&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="st">    </span><span class="kw">split_cols_by</span>(<span class="st">&quot;SEX&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="st">    </span><span class="kw">split_rows_by</span>(<span class="st">&quot;RACE&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="st">    </span><span class="kw">summarize_row_groups</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-6" title="6"><span class="st">    </span><span class="kw">split_rows_by</span>(<span class="st">&quot;STRATA1&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="st">    </span><span class="kw">summarize_row_groups</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-8" title="8"><span class="st">    </span><span class="kw">analyze</span>(<span class="st">&quot;AGE&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="st">    </span><span class="kw">build_table</span>(DM)</a>
<a class="sourceLine" id="cb2-10" title="10">rawtable</a></code></pre></div>
<pre><code>                                                                  A: Drug X                                             B: Placebo                                           C: Combination                    
                                                F            M           U       UNDIFFERENTIATED       F           M          U       UNDIFFERENTIATED       F            M           U       UNDIFFERENTIATED
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ASIAN                                       44 (62.9%)   35 (68.6%)   0 (NaN%)       0 (NaN%)       37 (66.1%)   31 (62%)   0 (NaN%)       0 (NaN%)       40 (65.6%)   44 (64.7%)   0 (NaN%)       0 (NaN%)    
  A                                         15 (21.4%)   12 (23.5%)   0 (NaN%)       0 (NaN%)        14 (25%)    6 (12%)    0 (NaN%)       0 (NaN%)       15 (24.6%)   16 (23.5%)   0 (NaN%)       0 (NaN%)    
    Mean                                       30.4        34.42        NaN            NaN            35.43       30.33       NaN            NaN             37.4        36.25        NaN            NaN       
  B                                         16 (22.9%)   8 (15.7%)    0 (NaN%)       0 (NaN%)       13 (23.2%)   16 (32%)   0 (NaN%)       0 (NaN%)       10 (16.4%)   12 (17.6%)   0 (NaN%)       0 (NaN%)    
    Mean                                      33.75        34.88        NaN            NaN            32.46       30.94       NaN            NaN             33.3        35.92        NaN            NaN       
  C                                         13 (18.6%)   15 (29.4%)   0 (NaN%)       0 (NaN%)       10 (17.9%)   9 (18%)    0 (NaN%)       0 (NaN%)       15 (24.6%)   16 (23.5%)   0 (NaN%)       0 (NaN%)    
    Mean                                      36.92         35.6        NaN            NaN              34        31.89       NaN            NaN            33.47        31.38        NaN            NaN       
BLACK OR AFRICAN AMERICAN                   18 (25.7%)   10 (19.6%)   0 (NaN%)       0 (NaN%)       12 (21.4%)   12 (24%)   0 (NaN%)       0 (NaN%)       13 (21.3%)   14 (20.6%)   0 (NaN%)       0 (NaN%)    
  A                                          5 (7.1%)      1 (2%)     0 (NaN%)       0 (NaN%)        5 (8.9%)     2 (4%)    0 (NaN%)       0 (NaN%)        4 (6.6%)     4 (5.9%)    0 (NaN%)       0 (NaN%)    
    Mean                                       31.2          33         NaN            NaN              28          30        NaN            NaN            30.75         36.5        NaN            NaN       
  B                                          7 (10%)      3 (5.9%)    0 (NaN%)       0 (NaN%)        3 (5.4%)     3 (6%)    0 (NaN%)       0 (NaN%)        6 (9.8%)     6 (8.8%)    0 (NaN%)       0 (NaN%)    
    Mean                                      36.14        34.33        NaN            NaN            29.67         32        NaN            NaN            36.33          31         NaN            NaN       
  C                                          6 (8.6%)    6 (11.8%)    0 (NaN%)       0 (NaN%)        4 (7.1%)    7 (14%)    0 (NaN%)       0 (NaN%)        3 (4.9%)     4 (5.9%)    0 (NaN%)       0 (NaN%)    
    Mean                                      31.33        39.67        NaN            NaN             34.5         34        NaN            NaN              33          36.5        NaN            NaN       
WHITE                                       8 (11.4%)    6 (11.8%)    0 (NaN%)       0 (NaN%)       7 (12.5%)    7 (14%)    0 (NaN%)       0 (NaN%)       8 (13.1%)    10 (14.7%)   0 (NaN%)       0 (NaN%)    
  A                                          2 (2.9%)      1 (2%)     0 (NaN%)       0 (NaN%)        3 (5.4%)     3 (6%)    0 (NaN%)       0 (NaN%)        1 (1.6%)     5 (7.4%)    0 (NaN%)       0 (NaN%)    
    Mean                                        34           45         NaN            NaN            29.33       33.33       NaN            NaN              35          32.8        NaN            NaN       
  B                                          4 (5.7%)     3 (5.9%)    0 (NaN%)       0 (NaN%)        1 (1.8%)     4 (8%)    0 (NaN%)       0 (NaN%)        3 (4.9%)     1 (1.5%)    0 (NaN%)       0 (NaN%)    
    Mean                                        37         43.67        NaN            NaN              48        36.75       NaN            NaN            34.33          36         NaN            NaN       
  C                                          2 (2.9%)     2 (3.9%)    0 (NaN%)       0 (NaN%)        3 (5.4%)     0 (0%)    0 (NaN%)       0 (NaN%)        4 (6.6%)     4 (5.9%)    0 (NaN%)       0 (NaN%)    
    Mean                                       35.5          44         NaN            NaN            44.67        NaN        NaN            NaN             38.5          35         NaN            NaN       
AMERICAN INDIAN OR ALASKA NATIVE              0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
  A                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  B                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  C                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
MULTIPLE                                      0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
  A                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  B                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  C                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER     0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
  A                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  B                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  C                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
OTHER                                         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
  A                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  B                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  C                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
UNKNOWN                                       0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
  A                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  B                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       
  C                                           0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)         0 (0%)      0 (0%)    0 (NaN%)       0 (NaN%)         0 (0%)       0 (0%)     0 (NaN%)       0 (NaN%)    
    Mean                                       NaN          NaN         NaN            NaN             NaN         NaN        NaN            NaN             NaN          NaN         NaN            NaN       </code></pre>
</div>
<div id="trimming" class="section level2">
<h2>Trimming</h2>
<div id="rows" class="section level3">
<h3>Rows</h3>
<p>Trimming represents a convenience wrapper around simple, direct subsetting of the rows of a <code>TableTree</code>.</p>
<p>We use the <code>trim_rows()</code> function and pass it our table and a critera function. All rows where the criteria function returns <code>TRUE</code> will be removed, all others will be retained.</p>
<p><strong>NOTE</strong>: each row is kept or removed completely independently, with no awareness of the surrounding structure. This means, for example, that a subtree could have all its analysis rows removed and not be removed itself. For structure-aware filtering of a table, we will use <em>pruning</em> described in the next section.</p>
<p>A <em>trimming function</em> accepts a <code>TableRow</code> object and returns <code>TRUE</code> if the row should be removed.</p>
<p>The default trimming function removes rows that have no values in them that have all <code>NA</code> values or all <code>0</code> values (but not if there is a mix)</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">trim_rows</span>(rawtable)</a></code></pre></div>
<pre><code>                                                  A: Drug X                                             B: Placebo                                           C: Combination                    
                                F            M           U       UNDIFFERENTIATED       F           M          U       UNDIFFERENTIATED       F            M           U       UNDIFFERENTIATED
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ASIAN                       44 (62.9%)   35 (68.6%)   0 (NaN%)       0 (NaN%)       37 (66.1%)   31 (62%)   0 (NaN%)       0 (NaN%)       40 (65.6%)   44 (64.7%)   0 (NaN%)       0 (NaN%)    
  A                         15 (21.4%)   12 (23.5%)   0 (NaN%)       0 (NaN%)        14 (25%)    6 (12%)    0 (NaN%)       0 (NaN%)       15 (24.6%)   16 (23.5%)   0 (NaN%)       0 (NaN%)    
    Mean                       30.4        34.42        NaN            NaN            35.43       30.33       NaN            NaN             37.4        36.25        NaN            NaN       
  B                         16 (22.9%)   8 (15.7%)    0 (NaN%)       0 (NaN%)       13 (23.2%)   16 (32%)   0 (NaN%)       0 (NaN%)       10 (16.4%)   12 (17.6%)   0 (NaN%)       0 (NaN%)    
    Mean                      33.75        34.88        NaN            NaN            32.46       30.94       NaN            NaN             33.3        35.92        NaN            NaN       
  C                         13 (18.6%)   15 (29.4%)   0 (NaN%)       0 (NaN%)       10 (17.9%)   9 (18%)    0 (NaN%)       0 (NaN%)       15 (24.6%)   16 (23.5%)   0 (NaN%)       0 (NaN%)    
    Mean                      36.92         35.6        NaN            NaN              34        31.89       NaN            NaN            33.47        31.38        NaN            NaN       
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   0 (NaN%)       0 (NaN%)       12 (21.4%)   12 (24%)   0 (NaN%)       0 (NaN%)       13 (21.3%)   14 (20.6%)   0 (NaN%)       0 (NaN%)    
  A                          5 (7.1%)      1 (2%)     0 (NaN%)       0 (NaN%)        5 (8.9%)     2 (4%)    0 (NaN%)       0 (NaN%)        4 (6.6%)     4 (5.9%)    0 (NaN%)       0 (NaN%)    
    Mean                       31.2          33         NaN            NaN              28          30        NaN            NaN            30.75         36.5        NaN            NaN       
  B                          7 (10%)      3 (5.9%)    0 (NaN%)       0 (NaN%)        3 (5.4%)     3 (6%)    0 (NaN%)       0 (NaN%)        6 (9.8%)     6 (8.8%)    0 (NaN%)       0 (NaN%)    
    Mean                      36.14        34.33        NaN            NaN            29.67         32        NaN            NaN            36.33          31         NaN            NaN       
  C                          6 (8.6%)    6 (11.8%)    0 (NaN%)       0 (NaN%)        4 (7.1%)    7 (14%)    0 (NaN%)       0 (NaN%)        3 (4.9%)     4 (5.9%)    0 (NaN%)       0 (NaN%)    
    Mean                      31.33        39.67        NaN            NaN             34.5         34        NaN            NaN              33          36.5        NaN            NaN       
WHITE                       8 (11.4%)    6 (11.8%)    0 (NaN%)       0 (NaN%)       7 (12.5%)    7 (14%)    0 (NaN%)       0 (NaN%)       8 (13.1%)    10 (14.7%)   0 (NaN%)       0 (NaN%)    
  A                          2 (2.9%)      1 (2%)     0 (NaN%)       0 (NaN%)        3 (5.4%)     3 (6%)    0 (NaN%)       0 (NaN%)        1 (1.6%)     5 (7.4%)    0 (NaN%)       0 (NaN%)    
    Mean                        34           45         NaN            NaN            29.33       33.33       NaN            NaN              35          32.8        NaN            NaN       
  B                          4 (5.7%)     3 (5.9%)    0 (NaN%)       0 (NaN%)        1 (1.8%)     4 (8%)    0 (NaN%)       0 (NaN%)        3 (4.9%)     1 (1.5%)    0 (NaN%)       0 (NaN%)    
    Mean                        37         43.67        NaN            NaN              48        36.75       NaN            NaN            34.33          36         NaN            NaN       
  C                          2 (2.9%)     2 (3.9%)    0 (NaN%)       0 (NaN%)        3 (5.4%)     0 (0%)    0 (NaN%)       0 (NaN%)        4 (6.6%)     4 (5.9%)    0 (NaN%)       0 (NaN%)    
    Mean                       35.5          44         NaN            NaN            44.67        NaN        NaN            NaN             38.5          35         NaN            NaN       </code></pre>
</div>
<div id="trimming-columns" class="section level3">
<h3>Trimming Columns</h3>
<p>There are currently no special utilities for trimming columns but we can remove the empty columns with fairly straightforward column subsetting:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">coltrimmed &lt;-<span class="st"> </span>rawtable[,<span class="kw">col_counts</span>(rawtable) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>]</a></code></pre></div>
<pre><code>Note: method with signature &#39;VTableTree#missing#ANY&#39; chosen for function &#39;[&#39;,
 target signature &#39;TableTree#missing#logical&#39;.
 &quot;VTableTree#ANY#logical&quot; would also be valid</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">head</span>(coltrimmed)</a></code></pre></div>
<pre><code>                  A: Drug X               B: Placebo             C: Combination     
               F            M            F           M           F            M     
------------------------------------------------------------------------------------
ASIAN      44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A        15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean      30.4        34.42        35.43       30.33        37.4        36.25   
  B        16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean     33.75        34.88        32.46       30.94        33.3        35.92   
  C        13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)</code></pre>
</div>
</div>
<div id="pruning" class="section level2">
<h2>Pruning</h2>
<p>Pruning is similar in outcome to trimming, but more powerful and more complex, as it takes structure into account.</p>
<p>Pruning is applied recursively, in that at each structural unit (subtable, row) it both applies the pruning function at that level and to all it’s children (up to a user-specifiable maximum depth).</p>
<p>The default pruning funciton, for example, determines if a subtree is empty by</p>
<ol style="list-style-type: lower-alpha">
<li>Removing all children which contain a single content row which contains all zeros or all <code>NA</code>s</li>
<li>Removing rows which contain either all zeros or all <code>NA</code>s</li>
<li>Removing the full subtree if no unpruned children remain</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1">pruned &lt;-<span class="st"> </span><span class="kw">prune_table</span>(coltrimmed)</a>
<a class="sourceLine" id="cb10-2" title="2">pruned</a></code></pre></div>
<pre><code>                                   A: Drug X               B: Placebo             C: Combination     
                                F            M            F           M           F            M     
-----------------------------------------------------------------------------------------------------
ASIAN                       44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A                         15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean                       30.4        34.42        35.43       30.33        37.4        36.25   
  B                         16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean                      33.75        34.88        32.46       30.94        33.3        35.92   
  C                         13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean                      36.92         35.6          34        31.89       33.47        31.38   
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   12 (21.4%)   12 (24%)   13 (21.3%)   14 (20.6%)
  A                          5 (7.1%)      1 (2%)      5 (8.9%)     2 (4%)     4 (6.6%)     4 (5.9%) 
    Mean                       31.2          33           28          30        30.75         36.5   
  B                          7 (10%)      3 (5.9%)     3 (5.4%)     3 (6%)     6 (9.8%)     6 (8.8%) 
    Mean                      36.14        34.33        29.67         32        36.33          31    
  C                          6 (8.6%)    6 (11.8%)     4 (7.1%)    7 (14%)     3 (4.9%)     4 (5.9%) 
    Mean                      31.33        39.67         34.5         34          33          36.5   
WHITE                       8 (11.4%)    6 (11.8%)    7 (12.5%)    7 (14%)    8 (13.1%)    10 (14.7%)
  A                          2 (2.9%)      1 (2%)      3 (5.4%)     3 (6%)     1 (1.6%)     5 (7.4%) 
    Mean                        34           45         29.33       33.33         35          32.8   
  B                          4 (5.7%)     3 (5.9%)     1 (1.8%)     4 (8%)     3 (4.9%)     1 (1.5%) 
    Mean                        37         43.67          48        36.75       34.33          36    
  C                          2 (2.9%)     2 (3.9%)     3 (5.4%)     0 (0%)     4 (6.6%)     4 (5.9%) 
    Mean                       35.5          44         44.67        NaN         38.5          35    </code></pre>
<p>We can also use the <code>low_obs_pruner</code> pruning function constructor to create a pruning function which removes subtrees with content summaries whose first entries for each column sum or average to below a specified number. (In the default summaries the first entry per column is the count).</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1">pruned2 &lt;-<span class="st"> </span><span class="kw">prune_table</span>(coltrimmed, <span class="kw">low_obs_pruner</span>(<span class="dv">10</span>, <span class="st">&quot;mean&quot;</span>))</a>
<a class="sourceLine" id="cb12-2" title="2">pruned2</a></code></pre></div>
<pre><code>                  A: Drug X               B: Placebo             C: Combination     
               F            M            F           M           F            M     
------------------------------------------------------------------------------------
ASIAN      44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A        15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean      30.4        34.42        35.43       30.33        37.4        36.25   
  B        16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean     33.75        34.88        32.46       30.94        33.3        35.92   
  C        13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean     36.92         35.6          34        31.89       33.47        31.38   </code></pre>
<p>Note that because the pruning is being applied recursively, only the <code>ASIAN</code> subtree remains because even though the full <code>BLACK OR AFRICAN AMERICAN</code> subtree encompassed enough observations, the strata within it did not. We can take care of this by setting the <code>stop_depth</code> for pruning to <code>1</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">pruned3 &lt;-<span class="st"> </span><span class="kw">prune_table</span>(coltrimmed, <span class="kw">low_obs_pruner</span>(<span class="dv">10</span>, <span class="st">&quot;sum&quot;</span>), <span class="dt">stop_depth =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb14-2" title="2">pruned3</a></code></pre></div>
<pre><code>                                   A: Drug X               B: Placebo             C: Combination     
                                F            M            F           M           F            M     
-----------------------------------------------------------------------------------------------------
ASIAN                       44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A                         15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean                       30.4        34.42        35.43       30.33        37.4        36.25   
  B                         16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean                      33.75        34.88        32.46       30.94        33.3        35.92   
  C                         13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean                      36.92         35.6          34        31.89       33.47        31.38   
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   12 (21.4%)   12 (24%)   13 (21.3%)   14 (20.6%)
  A                          5 (7.1%)      1 (2%)      5 (8.9%)     2 (4%)     4 (6.6%)     4 (5.9%) 
    Mean                       31.2          33           28          30        30.75         36.5   
  B                          7 (10%)      3 (5.9%)     3 (5.4%)     3 (6%)     6 (9.8%)     6 (8.8%) 
    Mean                      36.14        34.33        29.67         32        36.33          31    
  C                          6 (8.6%)    6 (11.8%)     4 (7.1%)    7 (14%)     3 (4.9%)     4 (5.9%) 
    Mean                      31.33        39.67         34.5         34          33          36.5   
WHITE                       8 (11.4%)    6 (11.8%)    7 (12.5%)    7 (14%)    8 (13.1%)    10 (14.7%)
  A                          2 (2.9%)      1 (2%)      3 (5.4%)     3 (6%)     1 (1.6%)     5 (7.4%) 
    Mean                        34           45         29.33       33.33         35          32.8   
  B                          4 (5.7%)     3 (5.9%)     1 (1.8%)     4 (8%)     3 (4.9%)     1 (1.5%) 
    Mean                        37         43.67          48        36.75       34.33          36    
  C                          2 (2.9%)     2 (3.9%)     3 (5.4%)     0 (0%)     4 (6.6%)     4 (5.9%) 
    Mean                       35.5          44         44.67        NaN         38.5          35    </code></pre>
<p>We can also see that pruning to a lower number of observations, say, to a total of <code>16</code>, with no <code>stop_depth</code> removes some but not all of the strata from our third race (<code>WHITE</code>)</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1">pruned4 &lt;-<span class="st"> </span><span class="kw">prune_table</span>(coltrimmed, <span class="kw">low_obs_pruner</span>(<span class="dv">16</span>, <span class="st">&quot;sum&quot;</span>))</a>
<a class="sourceLine" id="cb16-2" title="2">pruned4</a></code></pre></div>
<pre><code>                                   A: Drug X               B: Placebo             C: Combination     
                                F            M            F           M           F            M     
-----------------------------------------------------------------------------------------------------
ASIAN                       44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A                         15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean                       30.4        34.42        35.43       30.33        37.4        36.25   
  B                         16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean                      33.75        34.88        32.46       30.94        33.3        35.92   
  C                         13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean                      36.92         35.6          34        31.89       33.47        31.38   
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   12 (21.4%)   12 (24%)   13 (21.3%)   14 (20.6%)
  A                          5 (7.1%)      1 (2%)      5 (8.9%)     2 (4%)     4 (6.6%)     4 (5.9%) 
    Mean                       31.2          33           28          30        30.75         36.5   
  B                          7 (10%)      3 (5.9%)     3 (5.4%)     3 (6%)     6 (9.8%)     6 (8.8%) 
    Mean                      36.14        34.33        29.67         32        36.33          31    
  C                          6 (8.6%)    6 (11.8%)     4 (7.1%)    7 (14%)     3 (4.9%)     4 (5.9%) 
    Mean                      31.33        39.67         34.5         34          33          36.5   
WHITE                       8 (11.4%)    6 (11.8%)    7 (12.5%)    7 (14%)    8 (13.1%)    10 (14.7%)
  B                          4 (5.7%)     3 (5.9%)     1 (1.8%)     4 (8%)     3 (4.9%)     1 (1.5%) 
    Mean                        37         43.67          48        36.75       34.33          36    </code></pre>
</div>
<div id="sorting" class="section level2">
<h2>Sorting</h2>
<p>Sorting an rtable is done <strong>at a path</strong> and recursively, meaning a sort opreation will occur at a particular location within the table, and the subtables( children) will both be reordered themselves and potentially have their own children reordered as well.</p>
<p>This is done by giving a <em>score function</em> which accepts a subtree or TableRow and returns a single numeric value. Within the context currently being sorted, the subtrees are then reordered by the value of the score function.</p>
<p>Another difference between pruning and sorting is that sorting occurs at particular places in the table, as defined by a path. The path can contain &quot;*&quot; to indicate that at that portion of the structure sorting should occur <strong>separately</strong> within branch of the path.</p>
<p>Sort the strata by observation counts within just the <code>ASIAN</code> subtable:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">sort_at_path</span>(pruned, <span class="dt">path =</span> <span class="kw">c</span>(<span class="st">&quot;RACE&quot;</span>, <span class="st">&quot;ASIAN&quot;</span>, <span class="st">&quot;STRATA1&quot;</span>), <span class="dt">scorefun =</span> cont_n_allcols)</a></code></pre></div>
<pre><code>                                   A: Drug X               B: Placebo             C: Combination     
                                F            M            F           M           F            M     
-----------------------------------------------------------------------------------------------------
ASIAN                       44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A                         15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean                       30.4        34.42        35.43       30.33        37.4        36.25   
  C                         13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean                      36.92         35.6          34        31.89       33.47        31.38   
  B                         16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean                      33.75        34.88        32.46       30.94        33.3        35.92   
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   12 (21.4%)   12 (24%)   13 (21.3%)   14 (20.6%)
  A                          5 (7.1%)      1 (2%)      5 (8.9%)     2 (4%)     4 (6.6%)     4 (5.9%) 
    Mean                       31.2          33           28          30        30.75         36.5   
  B                          7 (10%)      3 (5.9%)     3 (5.4%)     3 (6%)     6 (9.8%)     6 (8.8%) 
    Mean                      36.14        34.33        29.67         32        36.33          31    
  C                          6 (8.6%)    6 (11.8%)     4 (7.1%)    7 (14%)     3 (4.9%)     4 (5.9%) 
    Mean                      31.33        39.67         34.5         34          33          36.5   
WHITE                       8 (11.4%)    6 (11.8%)    7 (12.5%)    7 (14%)    8 (13.1%)    10 (14.7%)
  A                          2 (2.9%)      1 (2%)      3 (5.4%)     3 (6%)     1 (1.6%)     5 (7.4%) 
    Mean                        34           45         29.33       33.33         35          32.8   
  B                          4 (5.7%)     3 (5.9%)     1 (1.8%)     4 (8%)     3 (4.9%)     1 (1.5%) 
    Mean                        37         43.67          48        36.75       34.33          36    
  C                          2 (2.9%)     2 (3.9%)     3 (5.4%)     0 (0%)     4 (6.6%)     4 (5.9%) 
    Mean                       35.5          44         44.67        NaN         38.5          35    </code></pre>
<p>Sort the ethnicities by observations, increasing</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">ethsort &lt;-<span class="st"> </span><span class="kw">sort_at_path</span>(pruned, <span class="dt">path =</span> <span class="kw">c</span>(<span class="st">&quot;RACE&quot;</span>), <span class="dt">scorefun =</span> cont_n_allcols, <span class="dt">decreasing =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb20-2" title="2">ethsort</a></code></pre></div>
<pre><code>                                   A: Drug X               B: Placebo             C: Combination     
                                F            M            F           M           F            M     
-----------------------------------------------------------------------------------------------------
WHITE                       8 (11.4%)    6 (11.8%)    7 (12.5%)    7 (14%)    8 (13.1%)    10 (14.7%)
  A                          2 (2.9%)      1 (2%)      3 (5.4%)     3 (6%)     1 (1.6%)     5 (7.4%) 
    Mean                        34           45         29.33       33.33         35          32.8   
  B                          4 (5.7%)     3 (5.9%)     1 (1.8%)     4 (8%)     3 (4.9%)     1 (1.5%) 
    Mean                        37         43.67          48        36.75       34.33          36    
  C                          2 (2.9%)     2 (3.9%)     3 (5.4%)     0 (0%)     4 (6.6%)     4 (5.9%) 
    Mean                       35.5          44         44.67        NaN         38.5          35    
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   12 (21.4%)   12 (24%)   13 (21.3%)   14 (20.6%)
  A                          5 (7.1%)      1 (2%)      5 (8.9%)     2 (4%)     4 (6.6%)     4 (5.9%) 
    Mean                       31.2          33           28          30        30.75         36.5   
  B                          7 (10%)      3 (5.9%)     3 (5.4%)     3 (6%)     6 (9.8%)     6 (8.8%) 
    Mean                      36.14        34.33        29.67         32        36.33          31    
  C                          6 (8.6%)    6 (11.8%)     4 (7.1%)    7 (14%)     3 (4.9%)     4 (5.9%) 
    Mean                      31.33        39.67         34.5         34          33          36.5   
ASIAN                       44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A                         15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean                       30.4        34.42        35.43       30.33        37.4        36.25   
  B                         16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean                      33.75        34.88        32.46       30.94        33.3        35.92   
  C                         13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean                      36.92         35.6          34        31.89       33.47        31.38   </code></pre>
<p>Within each ethnicity separately, sort the strata by number of females in arm c (ie column position <code>5</code>)</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">sort_at_path</span>(pruned, <span class="dt">path =</span> <span class="kw">c</span>(<span class="st">&quot;RACE&quot;</span>, <span class="st">&quot;*&quot;</span>, <span class="st">&quot;STRATA1&quot;</span>), <span class="kw">cont_n_onecol</span>(<span class="dv">5</span>))</a></code></pre></div>
<pre><code>                                   A: Drug X               B: Placebo             C: Combination     
                                F            M            F           M           F            M     
-----------------------------------------------------------------------------------------------------
ASIAN                       44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A                         15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean                       30.4        34.42        35.43       30.33        37.4        36.25   
  C                         13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean                      36.92         35.6          34        31.89       33.47        31.38   
  B                         16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean                      33.75        34.88        32.46       30.94        33.3        35.92   
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   12 (21.4%)   12 (24%)   13 (21.3%)   14 (20.6%)
  B                          7 (10%)      3 (5.9%)     3 (5.4%)     3 (6%)     6 (9.8%)     6 (8.8%) 
    Mean                      36.14        34.33        29.67         32        36.33          31    
  A                          5 (7.1%)      1 (2%)      5 (8.9%)     2 (4%)     4 (6.6%)     4 (5.9%) 
    Mean                       31.2          33           28          30        30.75         36.5   
  C                          6 (8.6%)    6 (11.8%)     4 (7.1%)    7 (14%)     3 (4.9%)     4 (5.9%) 
    Mean                      31.33        39.67         34.5         34          33          36.5   
WHITE                       8 (11.4%)    6 (11.8%)    7 (12.5%)    7 (14%)    8 (13.1%)    10 (14.7%)
  C                          2 (2.9%)     2 (3.9%)     3 (5.4%)     0 (0%)     4 (6.6%)     4 (5.9%) 
    Mean                       35.5          44         44.67        NaN         38.5          35    
  B                          4 (5.7%)     3 (5.9%)     1 (1.8%)     4 (8%)     3 (4.9%)     1 (1.5%) 
    Mean                        37         43.67          48        36.75       34.33          36    
  A                          2 (2.9%)      1 (2%)      3 (5.4%)     3 (6%)     1 (1.6%)     5 (7.4%) 
    Mean                        34           45         29.33       33.33         35          32.8   </code></pre>
<div id="sorting-within-an-analysis-subtable" class="section level3">
<h3>Sorting Within an Analysis Subtable</h3>
<p>When sorting within an analysis subtable (e.g., the subtable generated when your analysis function generates more than one row per group of data), the name of that subtable (generally the name of the variable being analyzed) must appear in the path, <em><strong>even if the variable label is not displayed when the table is printed</strong></em></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1">silly_afun =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb24-2" title="2">    <span class="kw">in_rows</span>(<span class="dt">a =</span> <span class="kw">rcell</span>(<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb24-3" title="3">            <span class="dt">b =</span> <span class="kw">rcell</span>(<span class="dv">3</span>),</a>
<a class="sourceLine" id="cb24-4" title="4">            <span class="dt">c =</span> <span class="kw">rcell</span>(<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb24-5" title="5">}</a>
<a class="sourceLine" id="cb24-6" title="6"></a>
<a class="sourceLine" id="cb24-7" title="7"></a>
<a class="sourceLine" id="cb24-8" title="8"></a>
<a class="sourceLine" id="cb24-9" title="9">sillytbl &lt;-<span class="st"> </span><span class="kw">basic_table</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">split_rows_by</span>(<span class="st">&quot;cyl&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="st">    </span><span class="kw">analyze</span>(<span class="st">&quot;mpg&quot;</span>, silly_afun) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-11" title="11"><span class="st">    </span><span class="kw">build_table</span>(mtcars)</a></code></pre></div>
<pre><code>Split var [cyl] was not character or factor. Converting to factor</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1">sillytbl</a></code></pre></div>
<pre><code>      all obs
-------------
6            
  a      2   
  b      3   
  c      1   
4            
  a      2   
  b      3   
  c      1   
8            
  a      2   
  b      3   
  c      1   </code></pre>
<p>The path required to sort the rows inside our “analysis” of <code>mpg</code>, then is <code>c(&quot;cyl&quot;, &quot;*&quot;, &quot;mpg&quot;)</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" title="1">scorefun &lt;-<span class="st"> </span><span class="cf">function</span>(tt) { <span class="kw">mean</span>(<span class="kw">unlist</span>(<span class="kw">row_values</span>(tt)))}</a>
<a class="sourceLine" id="cb28-2" title="2"><span class="kw">sort_at_path</span>(sillytbl, <span class="kw">c</span>(<span class="st">&quot;cyl&quot;</span>, <span class="st">&quot;*&quot;</span>, <span class="st">&quot;mpg&quot;</span>), scorefun)</a></code></pre></div>
<pre><code>      all obs
-------------
6            
  b      3   
  a      2   
  c      1   
4            
  b      3   
  a      2   
  c      1   
8            
  b      3   
  a      2   
  c      1   </code></pre>
</div>
</div>
<div id="writing-custom-pruning-criteria-and-scoring-functions" class="section level1">
<h1>Writing Custom Pruning Criteria and Scoring Functions</h1>
<p>Pruning criteria and scoring functions map TableTree or TableRow objects to a boolean value (for pruning criteria) or a sortable scalar value (scoring functions). To do this we currently need to interact with the structure of the objects in more than usual.</p>
<div id="useful-functions-and-accessors" class="section level2">
<h2>Useful Functions and Accessors</h2>
<p><code>content_table</code> Retrieves a <code>TableTree</code> object’s content table (which contains its summary rows).</p>
<p><code>tree_children</code> Retrieves a <code>TableTree</code> object’s children (either subtables, rows or possibly a mix thereof, though that should not happen in practice)</p>
<p><code>row_values</code> Retrieves a <code>TableRow</code> object’s values in the form of a list of length <code>ncol(tt)</code></p>
<p><code>vapply(row_values(tt), &#39;[[&#39;, i=1, numeric(1))</code> will retrieve the first element from each cell provided <code>tt</code> is a TableRow (and the first element is a numeric value).</p>
<p><code>obj_name</code> Retrieves the name of an object. Note this can differ from the label that is displayed (if any is) when printing. This will match the element in the path.</p>
<p><code>obj_label</code> Retrieves the display label of an object. Note this can differ from the name that appears in the path.</p>
</div>
<div id="example-custom-scoring-functions" class="section level2">
<h2>Example Custom Scoring Functions</h2>
<div id="sort-by-a-character-score" class="section level3">
<h3>Sort by a character “score”</h3>
<p>In this case, for convenience/simplicity, we use the name of the table element but any logic which returns a single string could be used here.</p>
<p>We sort the ethnicities by alphabetical order (in practice undoing our previous sorting by ethnicity above).</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" title="1">silly_name_scorer =<span class="st"> </span><span class="cf">function</span>(tt) {</a>
<a class="sourceLine" id="cb30-2" title="2">    nm =<span class="st"> </span><span class="kw">obj_name</span>(tt)</a>
<a class="sourceLine" id="cb30-3" title="3">    <span class="kw">print</span>(nm)</a>
<a class="sourceLine" id="cb30-4" title="4">    nm</a>
<a class="sourceLine" id="cb30-5" title="5">}</a>
<a class="sourceLine" id="cb30-6" title="6"></a>
<a class="sourceLine" id="cb30-7" title="7"><span class="kw">sort_at_path</span>(ethsort, <span class="st">&quot;RACE&quot;</span>, silly_name_scorer)</a></code></pre></div>
<pre><code>[1] &quot;WHITE&quot;
[1] &quot;BLACK OR AFRICAN AMERICAN&quot;
[1] &quot;ASIAN&quot;</code></pre>
<pre><code>                                   A: Drug X               B: Placebo             C: Combination     
                                F            M            F           M           F            M     
-----------------------------------------------------------------------------------------------------
ASIAN                       44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  A                         15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean                       30.4        34.42        35.43       30.33        37.4        36.25   
  B                         16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean                      33.75        34.88        32.46       30.94        33.3        35.92   
  C                         13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean                      36.92         35.6          34        31.89       33.47        31.38   
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   12 (21.4%)   12 (24%)   13 (21.3%)   14 (20.6%)
  A                          5 (7.1%)      1 (2%)      5 (8.9%)     2 (4%)     4 (6.6%)     4 (5.9%) 
    Mean                       31.2          33           28          30        30.75         36.5   
  B                          7 (10%)      3 (5.9%)     3 (5.4%)     3 (6%)     6 (9.8%)     6 (8.8%) 
    Mean                      36.14        34.33        29.67         32        36.33          31    
  C                          6 (8.6%)    6 (11.8%)     4 (7.1%)    7 (14%)     3 (4.9%)     4 (5.9%) 
    Mean                      31.33        39.67         34.5         34          33          36.5   
WHITE                       8 (11.4%)    6 (11.8%)    7 (12.5%)    7 (14%)    8 (13.1%)    10 (14.7%)
  A                          2 (2.9%)      1 (2%)      3 (5.4%)     3 (6%)     1 (1.6%)     5 (7.4%) 
    Mean                        34           45         29.33       33.33         35          32.8   
  B                          4 (5.7%)     3 (5.9%)     1 (1.8%)     4 (8%)     3 (4.9%)     1 (1.5%) 
    Mean                        37         43.67          48        36.75       34.33          36    
  C                          2 (2.9%)     2 (3.9%)     3 (5.4%)     0 (0%)     4 (6.6%)     4 (5.9%) 
    Mean                       35.5          44         44.67        NaN         38.5          35    </code></pre>
<p><strong>NOTE</strong> generally this would be more appropriately done using the reorder_split_levels function within the layout rather than as a sort postprocessing step, but other character scorers may or may not not map as easily to layouting directives.</p>
</div>
<div id="sort-by-the-percent-difference-in-counts-between-genders-in-arm-c" class="section level3">
<h3>Sort by the Percent Difference in counts between genders in Arm C</h3>
<p>We need the F and M percents, only for Arm C (ie columns 5 and 6), differenced.</p>
<p>We will sort <em><strong>the strata within each ethnicity</strong></em> by the percent difference in counts between males and females in arm C. This is not statistically meaningful at all, and is fact a terrible idea because it reorders the strata seemingly (but not) at random within each race, but illustrates the various things we need to do inside custom sorting functions.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">silly_gender_diffcount =<span class="st"> </span><span class="cf">function</span>(tt) {</a>
<a class="sourceLine" id="cb33-2" title="2">    ctable =<span class="st"> </span><span class="kw">content_table</span>(tt) <span class="co">## get summary table at this location</span></a>
<a class="sourceLine" id="cb33-3" title="3">    crow =<span class="st"> </span><span class="kw">tree_children</span>(ctable)[[<span class="dv">1</span>]] <span class="co">## get first row in summary table</span></a>
<a class="sourceLine" id="cb33-4" title="4">    vals =<span class="st"> </span><span class="kw">row_values</span>(crow)</a>
<a class="sourceLine" id="cb33-5" title="5">    <span class="co">## we need to have a better api for specificying location in column space but currently we don&#39;t</span></a>
<a class="sourceLine" id="cb33-6" title="6">    mcount =<span class="st"> </span>vals[[<span class="dv">6</span>]][<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb33-7" title="7">    fcount =<span class="st"> </span>vals[[<span class="dv">5</span>]][<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb33-8" title="8">    (mcount <span class="op">-</span><span class="st"> </span>fcount)<span class="op">/</span>fcount</a>
<a class="sourceLine" id="cb33-9" title="9">}</a>
<a class="sourceLine" id="cb33-10" title="10"></a>
<a class="sourceLine" id="cb33-11" title="11"><span class="kw">sort_at_path</span>(pruned, <span class="kw">c</span>(<span class="st">&quot;RACE&quot;</span>, <span class="st">&quot;*&quot;</span>, <span class="st">&quot;STRATA1&quot;</span>), silly_gender_diffcount)</a></code></pre></div>
<pre><code>                                   A: Drug X               B: Placebo             C: Combination     
                                F            M            F           M           F            M     
-----------------------------------------------------------------------------------------------------
ASIAN                       44 (62.9%)   35 (68.6%)   37 (66.1%)   31 (62%)   40 (65.6%)   44 (64.7%)
  B                         16 (22.9%)   8 (15.7%)    13 (23.2%)   16 (32%)   10 (16.4%)   12 (17.6%)
    Mean                      33.75        34.88        32.46       30.94        33.3        35.92   
  A                         15 (21.4%)   12 (23.5%)    14 (25%)    6 (12%)    15 (24.6%)   16 (23.5%)
    Mean                       30.4        34.42        35.43       30.33        37.4        36.25   
  C                         13 (18.6%)   15 (29.4%)   10 (17.9%)   9 (18%)    15 (24.6%)   16 (23.5%)
    Mean                      36.92         35.6          34        31.89       33.47        31.38   
BLACK OR AFRICAN AMERICAN   18 (25.7%)   10 (19.6%)   12 (21.4%)   12 (24%)   13 (21.3%)   14 (20.6%)
  C                          6 (8.6%)    6 (11.8%)     4 (7.1%)    7 (14%)     3 (4.9%)     4 (5.9%) 
    Mean                      31.33        39.67         34.5         34          33          36.5   
  A                          5 (7.1%)      1 (2%)      5 (8.9%)     2 (4%)     4 (6.6%)     4 (5.9%) 
    Mean                       31.2          33           28          30        30.75         36.5   
  B                          7 (10%)      3 (5.9%)     3 (5.4%)     3 (6%)     6 (9.8%)     6 (8.8%) 
    Mean                      36.14        34.33        29.67         32        36.33          31    
WHITE                       8 (11.4%)    6 (11.8%)    7 (12.5%)    7 (14%)    8 (13.1%)    10 (14.7%)
  A                          2 (2.9%)      1 (2%)      3 (5.4%)     3 (6%)     1 (1.6%)     5 (7.4%) 
    Mean                        34           45         29.33       33.33         35          32.8   
  C                          2 (2.9%)     2 (3.9%)     3 (5.4%)     0 (0%)     4 (6.6%)     4 (5.9%) 
    Mean                       35.5          44         44.67        NaN         38.5          35    
  B                          4 (5.7%)     3 (5.9%)     1 (1.8%)     4 (8%)     3 (4.9%)     1 (1.5%) 
    Mean                        37         43.67          48        36.75       34.33          36    </code></pre>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
